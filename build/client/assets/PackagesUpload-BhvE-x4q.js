import{u as M,r as d,x as J,j as a,J as W}from"./vendor-react-GjWeapsa.js";import{d as _,u as $}from"./vendor-router-cHSbYr8A.js";import{p as N,a as E}from"./packagesVersions.service-FNVeQxB5.js";import{a as G}from"./api-Cdl3BoFR.js";import{u as H}from"./notification.service-DGIhKrzX.js";function K(s){if(Array.isArray(s))return s;if(s&&typeof s=="object"&&!Array.isArray(s)){const i=s,u=i.data??i.value??i.items;if(Array.isArray(u))return u}return[]}const T={getTechnology:async()=>{const s=await G.get("/technologies/all");return K(s.data)}};function ae(){const{t:s}=M("translation"),i=_(),u=$(),y=H(e=>e.showToast),[q,A]=d.useState([]),[k,x]=d.useState([]),[f,h]=d.useState(null),[U,I]=d.useState(null),[b,w]=d.useState(null),p=u.state,t=p?.isNew!==!1,{register:g,handleSubmit:L,formState:{errors:c},setValue:m,watch:R,clearErrors:P}=J({defaultValues:{name:"",description:"",technologyId:0,packageId:0,version:"",file:null}}),v=R("packageId"),j=g("file",{required:s("pages.packagesUpload.fileRequired")});d.useEffect(()=>{let e=!1;return h(null),(async()=>{try{const o=await T.getTechnology();e||x(Array.isArray(o)?o:[])}catch(o){if(!e){x([]);const n=o,l=n?.response?.status===401?"Faça login para carregar as tecnologias.":n?.response?.data?.message??"Erro ao carregar tecnologias. Verifique a conexão com a API.";h(l)}console.error("Erro ao carregar tecnologias:",o)}})(),()=>{e=!0}},[t]),d.useEffect(()=>{t||C().then(()=>{p?.packageId&&(m("packageId",p.packageId),w(p.packageId))})},[t,p?.packageId]),d.useEffect(()=>{v>0&&!t&&D(v)},[v,t]);const V=async()=>{h(null);try{const e=await T.getTechnology();x(Array.isArray(e)?e:[])}catch(e){console.error("Erro ao carregar tecnologias:",e),x([]),h("Erro ao carregar tecnologias.")}},C=async()=>{try{const e=await N.getPackageCompany();A(e)}catch(e){console.error("Erro ao carregar packages:",e)}},D=async e=>{try{const r=await N.getByIdPackage(e);m("name",r.name),m("description",r.description),m("technologyId",r.technology),w(e)}catch(r){console.error("Erro ao carregar package:",r)}},F=e=>{e.target.files&&e.target.files.length>0&&(I(e.target.files[0].name),P("file"))},z=e=>{e.preventDefault(),e.stopPropagation()},O=e=>{if(e.preventDefault(),e.stopPropagation(),e.dataTransfer.files&&e.dataTransfer.files.length>0){const r=e.dataTransfer.files[0];I(r.name);const o=new DataTransfer;o.items.add(r),m("file",o.files,{shouldValidate:!0}),P("file")}},B=async e=>{const r="[PackagesUpload.onSubmit]";try{if(t){console.log(r,"Criando novo pacote",{name:e.name,technologyId:e.technologyId});const o={name:e.name,description:e.description,technologyId:e.technologyId},n=await N.createPackege(o);if(console.log(r,"Pacote criado",{id:n.id}),e.file&&e.file.length>0){console.log(r,"Enviando versão (zip)",{packageId:n.id,version:e.version,file:e.file[0]?.name});const l={version:e.version,file:e.file[0],packageId:n.id,description:e.description};await E.createPackageVersion(l),console.log(r,"Versão criada com sucesso"),y("Sucess","Package create successfully","success"),i("/packages")}}else if(e.file&&e.file.length>0&&b){console.log(r,"Upgrade versão",{packageId:b,version:e.version,file:e.file[0]?.name});const o={version:e.version,file:e.file[0],packageId:b,description:e.description};await E.createPackageVersion(o),console.log(r,"Versão atualizada com sucesso"),y("Sucess","Package version update successfully","success"),i("/packages")}}catch(o){const n=o,l=n?.response?.data,S=l?.extensions?.errorDescription??l?.detail??l?.title??l?.message??s("pages.packagesUpload.uploadError");console.error(r,"Erro no submit",{message:S,status:n?.response?.status,code:n?.code,data:l}),y("Error",S,"error")}};return a.jsxs("div",{className:"min-h-screen bg-background",children:[a.jsxs("div",{className:"mb-6",children:[a.jsxs("button",{onClick:()=>i("/packages"),className:"text-primary hover:text-primary/80 mb-4",children:["← ",s("pages.packagesUpload.back")]}),a.jsx("h1",{className:"text-4xl font-semibold text-text-primary",children:s("pages.packagesUpload.title")})]}),a.jsxs("form",{onSubmit:L(B),className:"bg-white rounded-lg shadow-card p-6",children:[a.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[t&&a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[s("pages.packagesUpload.packageName")," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",...g("name",{required:t?s("pages.packagesUpload.nameRequired"):!1,minLength:{value:5,message:s("pages.packagesUpload.nameMinLength")}}),placeholder:"DOWLOANDS_NFE",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"}),c.name&&a.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.name.message})]}),!t&&a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[s("pages.packagesUpload.packageLabel")," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs("select",{...g("packageId",{required:t?!1:s("pages.packagesUpload.packageRequired"),min:{value:1,message:s("pages.packagesUpload.packageRequired")}}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary",children:[a.jsx("option",{value:0,children:s("pages.packagesUpload.filterPackage")}),q.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]}),c.packageId&&a.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.packageId.message})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[s("pages.packagesUpload.description")," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("textarea",{...g("description",{required:s("pages.packagesUpload.descriptionRequired"),minLength:{value:5,message:s("pages.packagesUpload.descriptionMinLength")}}),rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"}),c.description&&a.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.description.message})]}),t&&a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[s("pages.packagesUpload.technology")," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs("select",{...g("technologyId",{required:t?s("pages.packagesUpload.technologyRequired"):!1,min:{value:1,message:s("pages.packagesUpload.technologyRequired")}}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary",disabled:k.length===0&&!!f,children:[a.jsx("option",{value:0,children:s("pages.packagesUpload.filterTechnology")}),k.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]}),f&&a.jsxs("p",{className:"mt-1 text-sm text-amber-600 flex items-center gap-2",children:[f,a.jsx("button",{type:"button",onClick:V,className:"text-primary hover:underline font-medium",children:"Tentar novamente"})]}),k.length===0&&!f&&a.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Carregando tecnologias..."}),c.technologyId&&a.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.technologyId.message})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[s("pages.packagesUpload.version")," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",...g("version",{required:s("pages.packagesUpload.versionRequired"),pattern:{value:/^\d+\.\d+\.\d+$/,message:s("pages.packagesUpload.versionFormat")}}),placeholder:"1.0.0",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"}),c.version&&a.jsx("p",{className:"mt-1 text-sm text-red-600",children:c.version.message})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[s("pages.packagesUpload.file")," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs("div",{onDragOver:z,onDrop:O,className:"border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors",children:[a.jsx(W,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),a.jsx("input",{type:"file",...j,onChange:e=>{j.onChange&&j.onChange(e),F(e)},className:"hidden",id:"file-upload",accept:".zip,.rar,.7z"}),a.jsx("label",{htmlFor:"file-upload",className:"cursor-pointer text-primary hover:text-primary/80 font-medium",children:s("pages.packagesUpload.clickToUpload")}),U&&a.jsxs("p",{className:"mt-2 text-sm text-gray-600",children:[s("pages.packagesUpload.selectedFile"),": ",U]}),c.file&&a.jsx("p",{className:"mt-2 text-sm text-red-600",children:c.file.message})]})]})]}),a.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[a.jsx("button",{type:"button",onClick:()=>i("/packages"),className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:s("pages.packagesUpload.cancel")}),a.jsx("button",{type:"submit",className:"px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90",children:s(t?"pages.packagesUpload.create":"pages.packagesUpload.upgrade")})]})]})]})}export{ae as default};
